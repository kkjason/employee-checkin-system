<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>員工打卡系統</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Firebase 配置（請替換為您的 Firebase 項目配置）
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // i18next 多語言配置
    i18next.init({
      lng: 'zh', // 默認語言
      resources: {
        zh: {
          translation: {
            appTitle: "員工打卡系統",
            login: "登入",
            logout: "登出",
            username: "帳號",
            password: "密碼",
            checkIn: "上班打卡",
            checkOut: "下班打卡",
            location: "地點",
            name: "姓名",
            selectLocation: "選擇地點",
            checkInManagement: "打卡管理",
            ipManagement: "IP 管理",
            checkInTime: "上班時間",
            checkOutTime: "下班時間",
            device: "設備",
            ipAddress: "IP 位址",
            addIp: "新增 IP",
            delete: "刪除",
            noWifi: "請連接餐廳 Wi-Fi 後再打卡",
            confirmCheckIn: "您尚未上班打卡，是否確認上班打卡？",
            confirmCheckOut: "您尚未下班打卡，是否確認下班打卡？",
            wrongCheckIn: "您已上班打卡，請勿重複按上班按鈕",
            wrongCheckOut: "您尚未上班打卡，請先上班打卡",
            page: "頁",
            previous: "上一頁",
            next: "下一頁"
          }
        },
        vi: {
          translation: {
            appTitle: "Hệ thống chấm công nhân viên",
            login: "Đăng nhập",
            logout: "Đăng xuất",
            username: "Tài khoản",
            password: "Mật khẩu",
            checkIn: "Chấm công vào",
            checkOut: "Chấm công ra",
            location: "Địa điểm",
            name: "Họ tên",
            selectLocation: "Chọn địa điểm",
            checkInManagement: "Quản lý chấm công",
            ipManagement: "Quản lý IP",
            checkInTime: "Thời gian vào",
            checkOutTime: "Thời gian ra",
            device: "Thiết bị",
            ipAddress: "Địa chỉ IP",
            addIp: "Thêm IP",
            delete: "Xóa",
            noWifi: "Vui lòng kết nối Wi-Fi nhà hàng trước khi chấm công",
            confirmCheckIn: "Bạn chưa chấm công vào, bạn có muốn chấm công vào không?",
            confirmCheckOut: "Bạn chưa chấm công ra, bạn có muốn chấm công ra không?",
            wrongCheckIn: "Bạn đã chấm công vào, vui lòng không nhấn lại nút chấm công vào",
            wrongCheckOut: "Bạn chưa chấm công vào, vui lòng chấm công vào trước",
            page: "Trang",
            previous: "Trang trước",
            next: "Trang sau"
          }
        },
        en: {
          translation: {
            appTitle: "Employee Check-in System",
            login: "Login",
            logout: "Logout",
            username: "Username",
            password: "Password",
            checkIn: "Check In",
            checkOut: "Check Out",
            location: "Location",
            name: "Name",
            selectLocation: "Select Location",
            checkInManagement: "Check-in Management",
            ipManagement: "IP Management",
            checkInTime: "Check-in Time",
            checkOutTime: "Check-out Time",
            device: "Device",
            ipAddress: "IP Address",
            addIp: "Add IP",
            delete: "Delete",
            noWifi: "Please connect to restaurant Wi-Fi before checking in",
            confirmCheckIn: "You haven't checked in, do you want to check in?",
            confirmCheckOut: "You haven't checked out, do you want to check out?",
            wrongCheckIn: "You have already checked in, please do not press the check-in button again",
            wrongCheckOut: "You haven't checked in, please check in first",
            page: "Page",
            previous: "Previous",
            next: "Next"
          }
        }
      }
    });

    // 主應用組件
    function App() {
      const [user, setUser] = React.useState(null);
      const [lang, setLang] = React.useState('zh');

      // 語言切換
      const changeLanguage = (lng) => {
        i18next.changeLanguage(lng);
        setLang(lng);
      };

      // 監聽 Firebase 認證狀態
      React.useEffect(() => {
        auth.onAuthStateChanged((user) => {
          setUser(user);
        });
      }, []);

      return (
        <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
          <div className="w-full max-w-4xl bg-white shadow-lg rounded-lg p-6">
            <div className="flex justify-end mb-4">
              <button onClick={() => changeLanguage('zh')} className="px-2 py-1 mx-1 bg-blue-500 text-white rounded hover:bg-blue-600">中文</button>
              <button onClick={() => changeLanguage('vi')} className="px-2 py-1 mx-1 bg-blue-500 text-white rounded hover:bg-blue-600">Tiếng Việt</button>
              <button onClick={() => changeLanguage('en')} className="px-2 py-1 mx-1 bg-blue-500 text-white rounded hover:bg-blue-600">English</button>
            </div>
            {user ? <AdminPage /> : <CheckInPage />}
          </div>
        </div>
      );
    }

    // 員工打卡頁面
    function CheckInPage() {
      const [name, setName] = React.useState(localStorage.getItem('employeeName') || '');
      const [location, setLocation] = React.useState('宏匯');
      const [ip, setIp] = React.useState('');
      const [device, setDevice] = React.useState(navigator.userAgent);

      // 獲取設備 IP
      React.useEffect(() => {
        axios.get('https://api.ipify.org?format=json')
          .then(response => setIp(response.data.ip))
          .catch(() => alert(i18next.t('noWifi')));
      }, []);

      // 保存姓名到 localStorage
      React.useEffect(() => {
        localStorage.setItem('employeeName', name);
      }, [name]);

      // 檢查 IP 是否在白名單
      const checkIp = async () => {
        const ipSnapshot = await db.collection('allowedIPs').where('ipAddress', '==', ip).get();
        return !ipSnapshot.empty;
      };

      // 檢查是否已上班打卡
      const checkExistingCheckIn = async () => {
        const today = new Date().toISOString().split('T')[0];
        const snapshot = await db.collection('checkins')
          .where('name', '==', name)
          .where('checkInTime', '>=', today)
          .where('checkInTime', '<', new Date(new Date(today).setDate(new Date(today).getDate() + 1)).toISOString())
          .get();
        return snapshot.docs[0];
      };

      // 打卡邏輯
      const handleCheckIn = async () => {
        if (!(await checkIp())) {
          alert(i18next.t('noWifi'));
          return;
        }
        const existingCheckIn = await checkExistingCheckIn();
        if (existingCheckIn && existingCheckIn.data().checkInTime) {
          alert(i18next.t('wrongCheckIn'));
          return;
        }
        if (window.confirm(i18next.t('confirmCheckIn'))) {
          await db.collection('checkins').add({
            name,
            location,
            checkInTime: new Date().toISOString(),
            checkInDevice: device,
            checkOutTime: null,
            checkOutDevice: null
          });
          alert(i18next.t('checkIn') + '成功');
        }
      };

      const handleCheckOut = async () => {
        if (!(await checkIp())) {
          alert(i18next.t('noWifi'));
          return;
        }
        const existingCheckIn = await checkExistingCheckIn();
        if (!existingCheckIn || !existingCheckIn.data().checkInTime) {
          alert(i18next.t('wrongCheckOut'));
          return;
        }
        if (existingCheckIn.data().checkOutTime) {
          alert(i18next.t('confirmCheckOut'));
          return;
        }
        if (window.confirm(i18next.t('confirmCheckOut'))) {
          await db.collection('checkins').doc(existingCheckIn.id).update({
            checkOutTime: new Date().toISOString(),
            checkOutDevice: device
          });
          alert(i18next.t('checkOut') + '成功');
        }
      };

      return (
        <div>
          <h1 className="text-2xl font-bold mb-4">{i18next.t('appTitle')}</h1>
          <div className="mb-4">
            <label className="block mb-1">{i18next.t('location')}</label>
            <select value={location} onChange={(e) => setLocation(e.target.value)} className="w-full p-2 border rounded">
              <option value="宏匯">{i18next.t('selectLocation')}: 宏匯</option>
            </select>
          </div>
          <div className="mb-4">
            <label className="block mb-1">{i18next.t('name')}</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full p-2 border rounded"
              placeholder={i18next.t('name')}
            />
          </div>
          <div className="flex space-x-4">
            <button onClick={handleCheckIn} className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">{i18next.t('checkIn')}</button>
            <button onClick={handleCheckOut} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">{i18next.t('checkOut')}</button>
          </div>
        </div>
      );
    }

    // 管理者頁面
    function AdminPage() {
      const [tab, setTab] = React.useState('checkIn');
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');

      const handleLogin = () => {
        auth.signInWithEmailAndPassword(username, password)
          .catch(() => alert('登入失敗，請檢查帳號密碼'));
      };

      const handleLogout = () => {
        auth.signOut();
      };

      if (!auth.currentUser) {
        return (
          <div>
            <h1 className="text-2xl font-bold mb-4">{i18next.t('appTitle')}</h1>
            <div className="mb-4">
              <label className="block mb-1">{i18next.t('username')}</label>
              <input
                type="email"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full p-2 border rounded"
                placeholder={i18next.t('username')}
              />
            </div>
            <div className="mb-4">
              <label className="block mb-1">{i18next.t('password')}</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full p-2 border rounded"
                placeholder={i18next.t('password')}
              />
            </div>
            <button onClick={handleLogin} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">{i18next.t('login')}</button>
          </div>
        );
      }

      return (
        <div>
          <div className="flex justify-between mb-4">
            <h1 className="text-2xl font-bold">{i18next.t('appTitle')}</h1>
            <button onClick={handleLogout} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">{i18next.t('logout')}</button>
          </div>
          <div className="flex space-x-4 mb-4">
            <button onClick={() => setTab('checkIn')} className={`px-4 py-2 rounded ${tab === 'checkIn' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>{i18next.t('checkInManagement')}</button>
            <button onClick={() => setTab('ip')} className={`px-4 py-2 rounded ${tab === 'ip' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>{i18next.t('ipManagement')}</button>
          </div>
          {tab === 'checkIn' ? <CheckInManagement /> : <IpManagement />}
        </div>
      );
    }

    // 打卡管理組件
    function CheckInManagement() {
      const [checkins, setCheckins] = React.useState([]);
      const [page, setPage] = React.useState(1);
      const pageSize = 20;

      React.useEffect(() => {
        const fetchCheckins = async () => {
          const snapshot = await db.collection('checkins')
            .orderBy('checkInTime', 'desc')
            .limit(pageSize)
            .offset((page - 1) * pageSize)
            .get();
          setCheckins(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        };
        fetchCheckins();
      }, [page]);

      return (
        <div>
          <h2 className="text-xl font-bold mb-4">{i18next.t('checkInManagement')}</h2>
          <div className="flex justify-between mb-4">
            <button onClick={() => setPage(page > 1 ? page - 1 : 1)} className="px-4 py-2 bg-gray-200 rounded">{i18next.t('previous')}</button>
            <span>{i18next.t('page')} {page}</span>
            <button onClick={() => setPage(page + 1)} className="px-4 py-2 bg-gray-200 rounded">{i18next.t('next')}</button>
          </div>
          <table className="w-full border-collapse border">
            <thead>
              <tr>
                <th className="border p-2">{i18next.t('name')}</th>
                <th className="border p-2">{i18next.t('location')}</th>
                <th className="border p-2">{i18next.t('checkInTime')}</th>
                <th className="border p-2">{i18next.t('device')}</th>
                <th className="border p-2">{i18next.t('checkOutTime')}</th>
                <th className="border p-2">{i18next.t('device')}</th>
              </tr>
            </thead>
            <tbody>
              {checkins.map(checkin => (
                <tr key={checkin.id}>
                  <td className="border p-2">{checkin.name}</td>
                  <td className="border p-2">{checkin.location}</td>
                  <td className="border p-2">{checkin.checkInTime}</td>
                  <td className="border p-2">{checkin.checkInDevice}</td>
                  <td className="border p-2">{checkin.checkOutTime || '-'}</td>
                  <td className="border p-2">{checkin.checkOutDevice || '-'}</td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="flex justify-between mt-4">
            <button onClick={() => setPage(page > 1 ? page - 1 : 1)} className="px-4 py-2 bg-gray-200 rounded">{i18next.t('previous')}</button>
            <span>{i18next.t('page')} {page}</span>
            <button onClick={() => setPage(page + 1)} className="px-4 py-2 bg-gray-200 rounded">{i18next.t('next')}</button>
          </div>
        </div>
      );
    }

    // IP 管理組件
    function IpManagement() {
      const [ips, setIps] = React.useState([]);
      const [newIp, setNewIp] = React.useState('');

      React.useEffect(() => {
        const fetchIps = async () => {
          const snapshot = await db.collection('allowedIPs').get();
          setIps(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        };
        fetchIps();
      }, []);

      const addIp = async () => {
        if (newIp) {
          await db.collection('allowedIPs').add({ ipAddress: newIp });
          setNewIp('');
          const snapshot = await db.collection('allowedIPs').get();
          setIps(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }
      };

      const deleteIp = async (id) => {
        await db.collection('allowedIPs').doc(id).delete();
        setIps(ips.filter(ip => ip.id !== id));
      };

      return (
        <div>
          <h2 className="text-xl font-bold mb-4">{i18next.t('ipManagement')}</h2>
          <div className="mb-4">
            <input
              type="text"
              value={newIp}
              onChange={(e) => setNewIp(e.target.value)}
              className="p-2 border rounded mr-2"
              placeholder={i18next.t('ipAddress')}
            />
            <button onClick={addIp} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">{i18next.t('addIp')}</button>
          </div>
          <table className="w-full border-collapse border">
            <thead>
              <tr>
                <th className="border p-2">{i18next.t('ipAddress')}</th>
                <th className="border p-2">{i18next.t('delete')}</th>
              </tr>
            </thead>
            <tbody>
              {ips.map(ip => (
                <tr key={ip.id}>
                  <td className="border p-2">{ip.ipAddress}</td>
                  <td className="border p-2">
                    <button onClick={() => deleteIp(ip.id)} className="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">{i18next.t('delete')}</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // 渲染應用
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>