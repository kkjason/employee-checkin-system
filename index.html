<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>員工打卡系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
    }
    .modal button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal button:hover {
      background-color: #4338ca;
    }
  </style>
</head>
<body class="bg-gradient-to-r from-blue-100 to-indigo-100 min-h-screen p-4">
  <div class="container mx-auto">
    <!-- 登入容器 -->
    <div id="login-container" class="text-center text-gray-700">載入中...</div>

    <!-- 打卡頁面容器 -->
    <div id="checkin-container" class="hidden">
      <h1 class="text-3xl font-bold text-indigo-700 mb-6 text-center">員工打卡系統</h1>
      <div class="bg-white p-6 rounded-xl shadow-lg max-w-md mx-auto">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">打卡</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 mb-1">姓名</label>
            <input id="name-input" type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="請輸入您的姓名">
          </div>
          <div>
            <label class="block text-gray-700 mb-1">地點</label>
            <select id="location-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="宏匯">宏匯</option>
            </select>
          </div>
          <button id="checkin-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">上班打卡</button>
          <button id="checkout-btn" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition-colors duration-200">下班打卡</button>
          <button id="logout-btn" class="w-full bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 mt-4">登出</button>
        </div>
      </div>
    </div>

    <!-- 提示對話框 -->
    <div id="alert-modal" class="modal">
      <div class="modal-content">
        <p id="alert-message"></p>
        <button id="alert-close">確定</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { showLoginForm, generateDeviceFingerprint } from '/js/device_binding_flow.js';

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCv1ywEy0oaL8FNBLAEO-Ban5lMs26Y_gY",
      authDomain: "employee-checkin-system.firebaseapp.com",
      projectId: "employee-checkin-system",
      storageBucket: "employee-checkin-system.firebasestorage.app",
      messagingSenderId: "646412258577",
      appId: "1:646412258577:web:7f32d3c069c415c9b190b0"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM 元素
    const loginContainer = document.getElementById('login-container');
    const checkinContainer = document.getElementById('checkin-container');
    const nameInput = document.getElementById('name-input');
    const locationInput = document.getElementById('location-input');
    const checkinBtn = document.getElementById('checkin-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const alertModal = document.getElementById('alert-modal');
    const alertMessage = document.getElementById('alert-message');
    const alertClose = document.getElementById('alert-close');

    // 顯示多語言提示
    function showAlert(messages) {
      alertMessage.innerHTML = `
        <p>${messages.zh}</p>
        <p>${messages.vi}</p>
        <p>${messages.en}</p>
      `;
      alertModal.style.display = 'flex';
    }

    // 關閉提示
    alertClose.addEventListener('click', () => {
      alertModal.style.display = 'none';
    });

    // 獲取用戶 IP
    async function getUserIP() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('獲取 IP 失敗:', error);
        return null;
      }
    }

    // 檢查 IP 是否在白名單
    async function isIPWhitelisted(ip) {
      if (!ip) return false;
      try {
        const q = query(collection(db, 'whitelist'), where('ip', '==', ip));
        const snapshot = await getDocs(q);
        return !snapshot.empty;
      } catch (error) {
        console.error('檢查 IP 白名單失敗:', error);
        return false;
      }
    }

    // 等待 DOM 載入完成
    document.addEventListener('DOMContentLoaded', () => {
      // 身份驗證狀態監聽
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log('用戶 UID:', user.uid, '電子郵件:', user.email);
          if (!loginContainer || !checkinContainer) {
            console.error('找不到 loginContainer 或 checkinContainer');
            return;
          }
          loginContainer.classList.add('hidden');
          checkinContainer.classList.remove('hidden');
        } else {
          console.log('無用戶登入');
          if (!loginContainer || !checkinContainer) {
            console.error('找不到 loginContainer 或 checkinContainer');
            return;
          }
          loginContainer.classList.remove('hidden');
          checkinContainer.classList.add('hidden');
          const lang = localStorage.getItem('language') || 'zh';
          showLoginForm(auth, lang);
        }
      });

      // 上班打卡
      checkinBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const location = locationInput.value;
        const deviceFingerprint = await generateDeviceFingerprint();
        const userIP = await getUserIP();

        if (!name || !location) {
          showAlert({
            zh: '請輸入姓名和地點',
            vi: 'Vui lòng nhập tên và địa điểm',
            en: 'Please enter your name and location'
          });
          return;
        }

        if (!userIP) {
          showAlert({
            zh: '無法獲取您的 IP 地址，請檢查網絡',
            vi: 'Không thể lấy địa chỉ IP của bạn, vui lòng kiểm tra mạng',
            en: 'Unable to retrieve your IP address, please check your network'
          });
          return;
        }

        const isWhitelisted = await isIPWhitelisted(userIP);
        if (!isWhitelisted) {
          showAlert({
            zh: '請連接餐廳WIFI',
            vi: 'Vui lòng kết nối với WIFI của nhà hàng',
            en: 'Please connect to the restaurant WIFI'
          });
          return;
        }

        try {
          await addDoc(collection(db, 'checkins'), {
            name,
            location,
            type: 'checkin',
            timestamp: new Date().toISOString(),
            device: deviceFingerprint,
            userId: auth.currentUser.uid,
            ip: userIP
          });
          showAlert({
            zh: '上班打卡成功',
            vi: 'Điểm danh bắt đầu ca làm việc thành công',
            en: 'Check-in successful'
          });
        } catch (error) {
          console.error('打卡失敗:', error);
          showAlert({
            zh: `打卡失敗: ${error.message}`,
            vi: `Điểm danh thất bại: ${error.message}`,
            en: `Check-in failed: ${error.message}`
          });
        }
      });

      // 下班打卡
      checkoutBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const location = locationInput.value;
        const deviceFingerprint = await generateDeviceFingerprint();
        const userIP = await getUserIP();

        if (!name || !location) {
          showAlert({
            zh: '請輸入姓名和地點',
            vi: 'Vui lòng nhập tên và địa điểm',
            en: 'Please enter your name and location'
          });
          return;
        }

        if (!userIP) {
          showAlert({
            zh: '無法獲取您的 IP 地址，請檢查網絡',
            vi: 'Không thể lấy địa chỉ IP của bạn, vui lòng kiểm tra mạng',
            en: 'Unable to retrieve your IP address, please check your network'
          });
          return;
        }

        const isWhitelisted = await isIPWhitelisted(userIP);
        if (!isWhitelisted) {
          showAlert({
            zh: '請連接餐廳WIFI',
            vi: 'Vui lòng kết nối với WIFI của nhà hàng',
            en: 'Please connect to the restaurant WIFI'
          });
          return;
        }

        try {
          await addDoc(collection(db, 'checkins'), {
            name,
            location,
            type: 'checkout',
            timestamp: new Date().toISOString(),
            device: deviceFingerprint,
            userId: auth.currentUser.uid,
            ip: userIP
          });
          showAlert({
            zh: '下班打卡成功',
            vi: 'Điểm danh kết thúc ca làm việc thành công',
            en: 'Check-out successful'
          });
        } catch (error) {
          console.error('打卡失敗:', error);
          showAlert({
            zh: `打卡失敗: ${error.message}`,
            vi: `Điểm danh thất bại: ${error.message}`,
            en: `Check-out failed: ${error.message}`
          });
        }
      });

      // 登出
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          console.log('登出成功');
          window.location.reload();
        }).catch((error) => {
          showAlert({
            zh: `登出失敗: ${error.message}`,
            vi: `Đăng xuất thất bại: ${error.message}`,
            en: `Logout failed: ${error.message}`
          });
        });
      });
    });
  </script>
</body>
</html>
