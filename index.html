<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>員工打卡系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-100 to-indigo-100 min-h-screen p-4">
  <div class="container mx-auto">
    <!-- 登入容器 -->
    <div id="login-container" class="text-center text-gray-700">載入中...</div>

    <!-- 打卡頁面容器 -->
    <div id="checkin-container" class="hidden">
      <h1 class="text-3xl font-bold text-indigo-700 mb-6 text-center">員工打卡系統</h1>
      <div class="bg-white p-6 rounded-xl shadow-lg max-w-md mx-auto">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">打卡</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 mb-1">姓名</label>
            <input id="name-input" type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="請輸入您的姓名">
          </div>
          <div>
            <label class="block text-gray-700 mb-1">地點</label>
            <select id="location-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
              <option value="宏匯">宏匯</option>
            </select>
          </div>
          <button id="checkin-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">上班打卡</button>
          <button id="checkout-btn" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition-colors duration-200">下班打卡</button>
          <button id="logout-btn" class="w-full bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200 mt-4">登出</button>
        </div>
      </div>
      <div class="mt-4 text-center">
        <a href="/admin.html" class="text-indigo-600 hover:underline">前往管理頁面</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { showLoginForm, generateDeviceFingerprint } from '/js/device_binding_flow.js';

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCv1ywEy0oaL8FNBLAEO-Ban5lMs26Y_gY",
      authDomain: "employee-checkin-system.firebaseapp.com",
      projectId: "employee-checkin-system",
      storageBucket: "employee-checkin-system.firebasestorage.app",
      messagingSenderId: "646412258577",
      appId: "1:646412258577:web:7f32d3c069c415c9b190b0"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM 元素
    const loginContainer = document.getElementById('login-container');
    const checkinContainer = document.getElementById('checkin-container');
    const nameInput = document.getElementById('name-input');
    const locationInput = document.getElementById('location-input');
    const checkinBtn = document.getElementById('checkin-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // 獲取用戶 IP
    async function getUserIP() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('獲取 IP 失敗:', error);
        return null;
      }
    }

    // 檢查 IP 是否在白名單
    async function isIPWhitelisted(ip) {
      if (!ip) return false;
      try {
        const q = query(collection(db, 'whitelist'), where('ip', '==', ip));
        const snapshot = await getDocs(q);
        return !snapshot.empty;
      } catch (error) {
        console.error('檢查 IP 白名單失敗:', error);
        return false;
      }
    }

    // 等待 DOM 載入完成
    document.addEventListener('DOMContentLoaded', () => {
      // 身份驗證狀態監聽
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log('用戶 UID:', user.uid, '電子郵件:', user.email);
          if (!loginContainer || !checkinContainer) {
            console.error('找不到 loginContainer 或 checkinContainer');
            return;
          }
          loginContainer.classList.add('hidden');
          checkinContainer.classList.remove('hidden');
        } else {
          console.log('無用戶登入');
          if (!loginContainer || !checkinContainer) {
            console.error('找不到 loginContainer 或 checkinContainer');
            return;
          }
          loginContainer.classList.remove('hidden');
          checkinContainer.classList.add('hidden');
          showLoginForm(auth);
        }
      });

      // 上班打卡
      checkinBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const location = locationInput.value;
        const deviceFingerprint = await generateDeviceFingerprint();
        const userIP = await getUserIP();

        if (!name || !location) {
          alert('請輸入姓名和地點');
          return;
        }

        if (!userIP) {
          alert('無法獲取您的 IP 地址，請檢查網絡');
          return;
        }

        const isWhitelisted = await isIPWhitelisted(userIP);
        if (!isWhitelisted) {
          alert('您的 IP 地址不在白名單中，無法打卡');
          return;
        }

        try {
          await addDoc(collection(db, 'checkins'), {
            name,
            location,
            type: 'checkin',
            timestamp: new Date().toISOString(),
            device: deviceFingerprint,
            userId: auth.currentUser.uid,
            ip: userIP
          });
          alert('上班打卡成功');
        } catch (error) {
          console.error('打卡失敗:', error);
          alert('打卡失敗: ' + error.message);
        }
      });

      // 下班打卡
      checkoutBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const location = locationInput.value;
        const deviceFingerprint = await generateDeviceFingerprint();
        const userIP = await getUserIP();

        if (!name || !location) {
          alert('請輸入姓名和地點');
          return;
        }

        if (!userIP) {
          alert('無法獲取您的 IP 地址，請檢查網絡');
          return;
        }

        const isWhitelisted = await isIPWhitelisted(userIP);
        if (!isWhitelisted) {
          alert('您的 IP 地址不在白名單中，無法打卡');
          return;
        }

        try {
          await addDoc(collection(db, 'checkins'), {
            name,
            location,
            type: 'checkout',
            timestamp: new Date().toISOString(),
            device: deviceFingerprint,
            userId: auth.currentUser.uid,
            ip: userIP
          });
          alert('下班打卡成功');
        } catch (error) {
          console.error('打卡失敗:', error);
          alert('打卡失敗: ' + error.message);
        }
      });

      // 登出
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          console.log('登出成功');
          window.location.reload();
        }).catch((error) => {
          alert('登出失敗: ' + error.message);
        });
      });
    });
  </script>
</body>
</html>
