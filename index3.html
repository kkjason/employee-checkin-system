<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰“å¡ç³»çµ± index3</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>æ‰“å¡ç³»çµ± - index3</h1>

  <!-- ç™»å…¥å€åŸŸ -->
  <div id="login-container">
    <button id="login-btn">Google ç™»å…¥</button>
  </div>

  <!-- ä½¿ç”¨è€…è³‡è¨Šèˆ‡æ‰“å¡å€ -->
  <div id="user-container" style="display:none;">
    <p id="welcome-text"></p>
    <button id="checkin-btn">æ‰“å¡</button>
    <button id="logout-btn">ç™»å‡º</button>
  </div>

  <!-- æ‰“å¡ç´€éŒ„å€ -->
  <div id="record-container">
    <h3>æœ€è¿‘æ‰“å¡ç´€éŒ„</h3>
    <ul id="record-list"></ul>
  </div>
</div>

<script>
// ======================= Firebase åˆå§‹åŒ– =======================
const firebaseConfig = {
  apiKey: "ä½ çš„ API KEY",
  authDomain: "ä½ çš„ AUTH DOMAIN",
  projectId: "ä½ çš„ PROJECT ID",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ======================= DOM å…ƒç´  =======================
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const checkinBtn = document.getElementById('checkin-btn');
const welcomeText = document.getElementById('welcome-text');
const userContainer = document.getElementById('user-container');
const loginContainer = document.getElementById('login-container');
const recordList = document.getElementById('record-list');

// ======================= ç‹€æ…‹è®Šæ•¸ =======================
let currentUser = null;

// ğŸ†• é˜²é‡è¤‡æ‰“å¡è®Šæ•¸
let lastCheckinTime = 0; // æ¯«ç§’

// ======================= Google ç™»å…¥ =======================
loginBtn.addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
});

// ======================= ç™»å‡º =======================
logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

// ======================= ç›£è½ç™»å…¥ç‹€æ…‹ =======================
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    welcomeText.textContent = `æ­¡è¿ï¼Œ${user.displayName}`;
    userContainer.style.display = 'block';
    loginContainer.style.display = 'none';
    loadRecords();
  } else {
    currentUser = null;
    userContainer.style.display = 'none';
    loginContainer.style.display = 'block';
    recordList.innerHTML = '';
  }
});

// ======================= æ‰“å¡åŠŸèƒ½ =======================
checkinBtn.addEventListener('click', async () => {
  if(!currentUser) return;

  const now = Date.now();
  const interval = 30000; // 30 ç§’å…§ç¦æ­¢é‡è¤‡æ‰“å¡

  if(now - lastCheckinTime < interval){
    alert('è«‹å‹¿é€£çºŒæ‰“å¡ï¼Œè«‹ç¨å¾Œå†è©¦');
    return;
  }

  lastCheckinTime = now; // æ›´æ–°æœ€å¾Œæ‰“å¡æ™‚é–“

  try{
    await db.collection('checkins').add({
      uid: currentUser.uid,
      name: currentUser.displayName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('æ‰“å¡æˆåŠŸ');
    loadRecords();
  } catch(e){
    console.error('æ‰“å¡å¤±æ•—', e);
    alert('æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
});

// ======================= è®€å–æ‰“å¡ç´€éŒ„ =======================
async function loadRecords(){
  if(!currentUser) return;

  const snapshot = await db.collection('checkins')
    .where('uid','==',currentUser.uid)
    .orderBy('timestamp','desc')
    .limit(10)
    .get();

  recordList.innerHTML = '';
  snapshot.forEach(doc=>{
    const data = doc.data();
    const li = document.createElement('li');
    const time = data.timestamp ? data.timestamp.toDate().toLocaleString('zh-TW') : 'å°šæœªåŒæ­¥æ™‚é–“';
    li.textContent = `${time} - ${data.name}`;
    recordList.appendChild(li);
  });
}

// ======================= å…¶ä»–åŸæœ¬åŠŸèƒ½ =======================
// ä»¥ä¸‹ä¿ç•™åŸæœ¬ index.html çš„å…¶ä»–ç¨‹å¼ç¢¼ã€UI æˆ–äº‹ä»¶ç¶å®š
// ä¾‹å¦‚ï¼šé¡¯ç¤ºæ‰€æœ‰ä½¿ç”¨è€…æ‰“å¡ç´€éŒ„ã€ç®¡ç†å“¡åŠŸèƒ½ã€æ¨£å¼èª¿æ•´ã€æç¤ºè¨Šæ¯ç­‰
// ... é€™è£¡è«‹ä¿ç•™ index.html çš„å®Œæ•´ 400+ è¡Œé‚è¼¯
</script>
</body>
</html>
