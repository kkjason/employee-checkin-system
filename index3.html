<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打卡系統 index3</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <h1>打卡系統 - index3</h1>

  <!-- 登入區域 -->
  <div id="login-container">
    <button id="login-btn">Google 登入</button>
  </div>

  <!-- 使用者資訊與打卡區 -->
  <div id="user-container" style="display:none;">
    <p id="welcome-text"></p>
    <button id="checkin-btn">打卡</button>
    <button id="logout-btn">登出</button>
  </div>

  <!-- 打卡紀錄區 -->
  <div id="record-container">
    <h3>最近打卡紀錄</h3>
    <ul id="record-list"></ul>
  </div>
</div>

<script>
// ======================= Firebase 初始化 =======================
const firebaseConfig = {
  apiKey: "你的 API KEY",
  authDomain: "你的 AUTH DOMAIN",
  projectId: "你的 PROJECT ID",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ======================= DOM 元素 =======================
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const checkinBtn = document.getElementById('checkin-btn');
const welcomeText = document.getElementById('welcome-text');
const userContainer = document.getElementById('user-container');
const loginContainer = document.getElementById('login-container');
const recordList = document.getElementById('record-list');

// ======================= 狀態變數 =======================
let currentUser = null;

// 🆕 防重複打卡變數
let lastCheckinTime = 0; // 毫秒

// ======================= Google 登入 =======================
loginBtn.addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
});

// ======================= 登出 =======================
logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

// ======================= 監聽登入狀態 =======================
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    welcomeText.textContent = `歡迎，${user.displayName}`;
    userContainer.style.display = 'block';
    loginContainer.style.display = 'none';
    loadRecords();
  } else {
    currentUser = null;
    userContainer.style.display = 'none';
    loginContainer.style.display = 'block';
    recordList.innerHTML = '';
  }
});

// ======================= 打卡功能 =======================
checkinBtn.addEventListener('click', async () => {
  if(!currentUser) return;

  const now = Date.now();
  const interval = 30000; // 30 秒內禁止重複打卡

  if(now - lastCheckinTime < interval){
    alert('請勿連續打卡，請稍後再試');
    return;
  }

  lastCheckinTime = now; // 更新最後打卡時間

  try{
    await db.collection('checkins').add({
      uid: currentUser.uid,
      name: currentUser.displayName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('打卡成功');
    loadRecords();
  } catch(e){
    console.error('打卡失敗', e);
    alert('打卡失敗，請稍後再試');
  }
});

// ======================= 讀取打卡紀錄 =======================
async function loadRecords(){
  if(!currentUser) return;

  const snapshot = await db.collection('checkins')
    .where('uid','==',currentUser.uid)
    .orderBy('timestamp','desc')
    .limit(10)
    .get();

  recordList.innerHTML = '';
  snapshot.forEach(doc=>{
    const data = doc.data();
    const li = document.createElement('li');
    const time = data.timestamp ? data.timestamp.toDate().toLocaleString('zh-TW') : '尚未同步時間';
    li.textContent = `${time} - ${data.name}`;
    recordList.appendChild(li);
  });
}

// ======================= 其他原本功能 =======================
// 以下保留原本 index.html 的其他程式碼、UI 或事件綁定
// 例如：顯示所有使用者打卡紀錄、管理員功能、樣式調整、提示訊息等
// ... 這裡請保留 index.html 的完整 400+ 行邏輯
</script>
</body>
</html>
